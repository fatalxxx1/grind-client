repeat
    task.wait()
until game:IsLoaded()

local player = game.Players.LocalPlayer

--// Character Handling
local function GetCharacter()
    return player.Character or player.CharacterAdded:Wait()
end

local function GetRoot()
    local char = GetCharacter()
    return char:WaitForChild("HumanoidRootPart")
end

--// Vars
local Var = {
    Char = GetCharacter(),
    Root = GetRoot(),
    Food = workspace:WaitForChild("Interactions"):WaitForChild("Food"),
    Lake = workspace:WaitForChild("Interactions"):WaitForChild("Lakes")
}

-- Update character on respawn
player.CharacterAdded:Connect(function()
    Var.Char = GetCharacter()
    Var.Root = GetRoot()
end)

--// Default State
if Var.Root:GetAttribute("State") == nil then
    Var.Root:SetAttribute("State", "Idle")
end

local function IsIdle()
    return Var.Root and Var.Root:GetAttribute("State") == "Idle"
end

--// Remotes (kept for future use)
local Re = {
    Food = game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Food"),
    Drink = game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("DrinkRemote")
}

local function Dist(a, b)
    return (a - b).Magnitude
end

--// UI
do
    local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

    local Window = WindUI:CreateWindow({
        Title = "Shroom Grinder",
        Icon = "door-open"
    })

    local Section = Window:Section({
        Title = "Main",
        Icon = "chart-bar",
        Opened = true
    })

    local Tab1 = Section:Tab({
        Title = "Farm",
        Icon = "hamburger",
        Locked = false
    })

    _G.TG = false
    local Diet = nil
    local Carcass, Berry, Water = false, false, false

    -- Wait for GUI safely
    local PlayerGui = player:WaitForChild("PlayerGui")
    local CreatureGui = PlayerGui:WaitForChild("CreatureInfoGui")
    local ContainerFrame = CreatureGui:WaitForChild("ContainerFrame")

    local thirst = ContainerFrame.TabFrames.MyCreature.StatsFrame.VitalityFrame.Thirst.AmountLabel
    local hunger = ContainerFrame.TabFrames.MyCreature.StatsFrame.VitalityFrame.Hunger.AmountLabel
    local dietLabel = ContainerFrame.TabFrames.MyCreature.DietLabel
    local ContainerGui = PlayerGui:WaitForChild("SaveSelectionGui").ContainerFrame

    Tab1:Section({
        Title = tostring(Diet),
        Box = true,
        TextTransparency = 0.05,
        TextXAlignment = "Center",
        TextSize = 17,
        Opened = true
    })

    Tab1:Toggle({
        Title = "Start",
        Desc = "Start AFK",
        Icon = "bird",
        Type = "Checkbox",
        Value = false,

        Callback = function(state)
            _G.TG = state

            -- STOP
            if not _G.TG then
                if workspace:FindFirstChild(".") then
                    workspace["."]:Destroy()
                end
                return
            end

          

            -- Prevent duplicate safe parts
            if workspace:FindFirstChild(".") then
                workspace["."]:Destroy()
            end

            local safePart = Instance.new("Part")
            safePart.Size = Vector3.new(200, 1, 200)
            safePart.Transparency = 0.7
            safePart.Anchored = true
            safePart.Name = "."
            safePart.CFrame = CFrame.new(0, 1500, 0)
            safePart.Parent = workspace

            task.spawn(function()
                while _G.TG do
                    pcall(function()
                          Diet = tostring(dietLabel.Text)
                        -- Refresh root in case of respawn
                        Var.Root = GetRoot()

                        -- Safe stat parsing
                        local HMin, HMax = hunger.Text:match("(%d+)%/(%d+)")
                        local TMin, TMax = thirst.Text:match("(%d+)%/(%d+)")

                        HMin = tonumber(HMin) 
                        HMax = tonumber(HMax) 
                        TMin = tonumber(TMin) 
                        TMax = tonumber(TMax) 

                        -- Diet logic
                        if Diet == "Herbivore" or Diet == "Omnivore" then
                            Carcass, Berry, Water = false, true, true
                        elseif Diet == "Carnivore" then
                            Carcass, Berry, Water = true, false, true
                        elseif Diet == "Photocarnivore" then
                            Carcass, Berry, Water = true, false, false
                        elseif Diet == "Photovore" then
                            Carcass, Berry, Water = false, false, true
                        end

                        if not ContainerGui.Visible and dietLabel then

                            -- HUNGER
                            if HMin <= HMax and IsIdle() then
                                Var.Root:SetAttribute("State", "Eating")

                            -- THIRST
                            elseif TMin <= TMax and IsIdle() then
                                if Water then
                                    Var.Root:SetAttribute("State", "Drinking")

                                    for _, v in pairs(Var.Lake:GetChildren()) do
                                        if v:IsA("Model") and v.Name == "Lake" then
                                            Var.Root.CFrame = v:GetPivot()

                                            Re.Drink:FireServer(v)
                                            break
                                        end
                                    end
                                end
                            else
                                Var.Root:SetAttribute("State", "Idle")
                                Var.Root.CFrame = safePart.CFrame * CFrame.new(0, 5, 0)
                            end
                        end
                    end)

                    task.wait(0.2)
                end
            end)
        end
    })
end
